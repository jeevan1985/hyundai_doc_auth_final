<!doctype html>
<html lang="{{ LANG }}" data-theme="{{ THEME or 'auto' }}" data-bs-theme="{{ 'dark' if THEME=='dark' else ('light' if THEME in ['light','default'] else '' ) }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ TRANSLATIONS['app.title'] }}</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="alternate icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script>
      // Apply saved theme ASAP to avoid FOUC/flash before CSS loads
      (function(){
        try {
          var saved = localStorage.getItem('ui.theme');
          var server = '{{ THEME or "auto"}}';
          var t = (server && server.trim()) || (saved && saved.trim()) || 'default';
          document.documentElement.setAttribute('data-theme', t);
          if (t === 'dark') document.documentElement.setAttribute('data-bs-theme', 'dark');
          else if (t === 'light' || t === 'default') document.documentElement.setAttribute('data-bs-theme', 'light');
          else document.documentElement.setAttribute('data-bs-theme', '');
          try { document.body.setAttribute('data-theme', t); } catch(e){}
          try {
            if (t === 'dark') document.body.setAttribute('data-bs-theme', 'dark');
            else if (t === 'light' || t === 'default') document.body.setAttribute('data-bs-theme', 'light');
            else document.body.setAttribute('data-bs-theme', '');
          } catch(e){}
        } catch(e) {}
      })();
    </script>
    <link href="{{ url_for('static', filename='vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='vendor/bootstrap-icons/font/bootstrap-icons.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/themes.css') }}" rel="stylesheet">
    <script>
      // Fallback loader: if local Bootstrap CSS isn't applied, inject CDN CSS; always add CDN icons as safe overlay.
      document.addEventListener('DOMContentLoaded', function(){
        try {
          var probe = document.createElement('button');
          probe.type = 'button';
          probe.className = 'btn btn-primary';
          document.body.appendChild(probe);
          var cs = window.getComputedStyle(probe);
          var padded = parseFloat(cs.paddingLeft)||0;
          var radius = parseFloat(cs.borderRadius)||0;
          (probe.parentNode||document.documentElement).removeChild(probe);
          if (padded < 6 && radius < 2) {
            var cdn = document.createElement('link');
            cdn.rel='stylesheet';
            cdn.href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css';
            document.head.appendChild(cdn);
          }
        } catch(e) { /* no-op */ }
        try {
          var ic = document.createElement('link');
          ic.rel='stylesheet';
          ic.href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css';
          document.head.appendChild(ic);
        } catch(e) { /* no-op */ }
      });
    </script>
  </head>
  <body data-username="{{ current_user.username if current_user.is_authenticated }}">
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('main.index') }}">{{ TRANSLATIONS['app.title'] }}</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link{% if request.endpoint=='main.index' %} active{% endif %}" href="{{ url_for('main.index') }}"><i class="bi bi-table me-1"></i>{{ TRANSLATIONS['nav.results'] }}</a></li>
            <li class="nav-item"><a class="nav-link{% if request.endpoint=='main.admin' %} active{% endif %}" href="{{ url_for('main.admin') }}"><i class="bi bi-speedometer2 me-1"></i>{{ TRANSLATIONS['nav.admin'] }}</a></li>
            {% if current_user.is_authenticated and current_user.role == 'admin' %}
              <li class="nav-item"><a class="nav-link{% if request.endpoint=='main.users_index' %} active{% endif %}" href="{{ url_for('main.users_index') }}"><i class="bi bi-people me-1"></i>{{ TRANSLATIONS['nav.manage_users'] }}</a></li>
            {% endif %}
          </ul>
          <ul class="navbar-nav ms-auto align-items-center navbar-actions">
            <li class="nav-item me-2 d-flex align-items-center">
              <i class="bi bi-translate me-1" role="img" aria-label="{{ TRANSLATIONS['nav.language'] if TRANSLATIONS.get('nav.language') else 'Language' }}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-container="body" title="{{ TRANSLATIONS['nav.language'] if TRANSLATIONS.get('nav.language') else 'Language' }}"></i>
              <form class="d-flex" method="post" action="{{ url_for('main.set_lang') }}">
                <select name="lang" class="form-select form-select-sm language-select me-2" onchange="this.form.submit()" aria-label="Language">
                  <option value="en" {% if LANG=='en' %}selected{% endif %}>{{ TRANSLATIONS['nav.lang.en'] }}</option>
                  <option value="ko" {% if LANG=='ko' %}selected{% endif %}>{{ TRANSLATIONS['nav.lang.ko'] }}</option>
                </select>
              </form>
            </li>
            <li class="nav-item d-flex align-items-center">
              <i class="bi bi-palette me-1" role="img" aria-label="{{ TRANSLATIONS['nav.theme'] }}" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-container="body" title="{{ TRANSLATIONS['nav.theme'] }}"></i>
              <form class="d-flex" method="post" action="{{ url_for('main.set_theme') }}">
                <select name="theme" class="form-select form-select-sm theme-select" onchange="this.form.submit()" aria-label="{{ TRANSLATIONS['nav.theme'] }}">
                                                      <option value="light" {% if THEME in ['light','default','auto'] %}selected{% endif %}>{{ TRANSLATIONS['theme.light'] }}</option>
                  <option value="dark" {% if THEME=='dark' %}selected{% endif %}>{{ TRANSLATIONS['theme.dark'] }}</option>
                  <option value="retro" {% if THEME=='retro' %}selected{% endif %}>{{ TRANSLATIONS['theme.retro'] }}</option>
                  <option value="cyberpunk" {% if THEME=='cyberpunk' %}selected{% endif %}>{{ TRANSLATIONS['theme.cyberpunk'] }}</option>
                  <option value="glass" {% if THEME=='glass' %}selected{% endif %}>{{ TRANSLATIONS['theme.glass'] }}</option>
                </select>
              </form>
            </li>
            <style>
              /* Right-side controls spacing and compact selectors */
              .navbar-actions { display: flex; align-items: center; gap: 10px; }
              .navbar-actions .theme-select, .navbar-actions .language-select {
                max-width: 160px; width: auto; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
                margin-left: 4px; /* slight left shift to maintain spacing from username */
              }
              @media (max-width: 576px) {
                .navbar-actions { gap: 6px; }
                .navbar-actions .theme-select, .navbar-actions .language-select { max-width: 145px; }
              }
            </style>
            {% if current_user.is_authenticated %}
              <li class="nav-item"><span class="navbar-text me-2 username-text">{{ current_user.username }} ({{ current_user.role }})</span></li>
              <li class="nav-item"><a class="nav-link{% if request.endpoint=='main.profile' %} active{% endif %}" href="{{ url_for('main.profile') }}"><i class="bi bi-person-circle me-1"></i>{{ TRANSLATIONS['nav.profile'] }}</a></li>
              <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.logout') }}"><i class="bi bi-box-arrow-right me-1"></i>{{ TRANSLATIONS['nav.logout'] }}</a></li>
            {% else %}
              <li class="nav-item"><a class="nav-link{% if request.endpoint=='auth.login' %} active{% endif %}" href="{{ url_for('auth.login') }}"><i class="bi bi-box-arrow-in-right me-1"></i>{{ TRANSLATIONS['nav.login'] }}</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <main class="container-xxl py-4">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% block content %}{% endblock %}
    </main>

    <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <script>
      // Fallback to CDN Bootstrap JS if local vendor not available.
      if (typeof window.bootstrap === 'undefined') {
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js';
        document.head.appendChild(s);
      }
    </script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script>
      // Initialize Bootstrap tooltips globally
      document.addEventListener('DOMContentLoaded', function(){
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (el) {
          var placement = el.getAttribute('data-bs-placement') || 'top';
          new bootstrap.Tooltip(el, { container: 'body', boundary: 'viewport', placement: placement, trigger: 'hover focus' });
        });
      });
    </script>
    <script>
      // Password visibility toggle with a11y label
      document.addEventListener('click', function(e){
        const t = e.target;
        if (t && t.classList && t.classList.contains('toggle-pass')) {
          const input = t.closest('.input-group').querySelector('.user-pass');
          if (input) {
            const I18N = (window.I18N && window.I18N.dict) || {};
            if (input.type === 'password') { input.type = 'text'; t.setAttribute('aria-label', I18N['a11y.pass_hide'] || 'Hide password'); }
            else { input.type = 'password'; t.setAttribute('aria-label', I18N['a11y.pass_show'] || 'Show password'); }
          }
        }
      });
    </script>
    <script>
      // Expose translations to client scripts
      window.I18N = { lang: '{{ LANG }}', dict: {{ TRANSLATIONS | tojson }} };
    </script>
    <script src="{{ url_for('static', filename='result_controls.js') }}"></script>
  </body>
</html>
