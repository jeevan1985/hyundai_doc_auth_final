{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">{{ TRANSLATIONS['users.title'] }}</h4>
  <form class="d-flex align-items-center" method="get">
    <input type="hidden" name="page" value="1">
    <input class="form-control form-control-sm me-2" type="search" placeholder="{{ TRANSLATIONS['users.search_placeholder'] }}" aria-label="{{ TRANSLATIONS['users.search'] }}" name="user_q" value="{{ user_q or '' }}" style="max-width: 260px;">
    <button class="btn btn-sm btn-outline-success" type="submit">{{ TRANSLATIONS['users.search'] }}</button>
  </form>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h6 class="card-title">{{ TRANSLATIONS['users.create_user'] }}</h6>
    <form method="post" action="{{ url_for('main.users_create') }}" class="row gy-2 gx-3 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label">{{ TRANSLATIONS['users.username'] }}</label>
        <input type="text" name="username" class="form-control" required>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">{{ TRANSLATIONS['users.password'] }}</label>
        <input type="password" name="password" class="form-control" required>
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label">{{ TRANSLATIONS['users.role'] }}</label>
        <select name="role" class="form-select">
          <option value="viewer">{{ TRANSLATIONS['users.viewer'] }}</option>
          <option value="admin">{{ TRANSLATIONS['users.admin'] }}</option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <button class="btn btn-primary w-100" type="submit">{{ TRANSLATIONS['users.create'] }}</button>
      </div>
    </form>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover table-bordered table-sm align-middle" id="resultsTable" data-export-filename="user_details" data-enable-controls="false">
    <thead class="table-dark">
      <tr>
        <th scope="col">{{ TRANSLATIONS['users.id'] }}</th>
        <th scope="col">{{ TRANSLATIONS['users.username'] }}</th>
        <th scope="col">{{ TRANSLATIONS['users.role'] }}</th>
        <th scope="col">{{ TRANSLATIONS['users.created_at'] }}</th>
        <th scope="col" class="text-center">{{ TRANSLATIONS['users.actions'] }}</th>
      </tr>
    </thead>
    <tbody>
      {% if users %}
        {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>
            <td>
              <form class="d-inline" method="post" action="{{ url_for('main.users_update_role', user_id=u.id) }}">
                <div class="input-group input-group-sm">
                  <select name="role" class="form-select form-select-sm" data-bs-toggle="tooltip" title="{{ TRANSLATIONS['users.role'] }}">
                    <option value="viewer" {% if u.role == 'viewer' %}selected{% endif %}>{{ TRANSLATIONS['users.viewer'] }}</option>
                    <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>{{ TRANSLATIONS['users.admin'] }}</option>
                  </select>
                  <button class="btn btn-outline-secondary btn-sm" type="submit" data-bs-toggle="tooltip" title="{{ TRANSLATIONS['users.update'] }}"><i class="bi bi-arrow-repeat me-1"></i>{{ TRANSLATIONS['users.update'] }}</button>
                </div>
              </form>
            </td>
            <td>{{ u.created_at }}</td>
            <td class="text-center">
              <form class="d-inline" method="post" action="{{ url_for('main.users_update_password', user_id=u.id) }}">
                <div class="input-group input-group-sm">
                  <input type="password" name="password" class="form-control form-control-sm user-pass" placeholder="{{ TRANSLATIONS['users.new_password'] }}" required data-bs-toggle="tooltip" title="{{ TRANSLATIONS['users.new_password'] }}">
                  <button class="btn btn-outline-secondary btn-sm toggle-pass" type="button" aria-label="{{ TRANSLATIONS['a11y.pass_show'] }} / {{ TRANSLATIONS['a11y.pass_hide'] }}">üëÅ</button>
                  <button class="btn btn-outline-primary btn-sm" type="submit" data-bs-toggle="tooltip" title="{{ TRANSLATIONS['users.set_password'] }}"><i class="bi bi-key me-1"></i>{{ TRANSLATIONS['users.set_password'] }}</button>
                </div>
              </form>
              <form class="d-inline ms-2" method="post" action="{{ url_for('main.users_delete', user_id=u.id) }}" onsubmit="return confirm('{{ TRANSLATIONS['users.delete_confirm'].format(username=u.username) }}');">
                <button class="btn btn-outline-danger btn-sm" type="submit" data-bs-toggle="tooltip" title="{{ TRANSLATIONS['users.delete'] }}"><i class="bi bi-trash3 me-1"></i>{{ TRANSLATIONS['users.delete'] }}</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="5" class="text-center">{{ TRANSLATIONS['users.no_users'] }}</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link" href="?page={{ pagination.prev_page }}&per_page={{ pagination.per_page }}&user_q={{ user_q or '' }}">{{ TRANSLATIONS['index.previous'] }}</a>
    </li>
    <li class="page-item disabled"><a class="page-link" href="#">{{ TRANSLATIONS['common.page'] }} {{ pagination.page }} {{ TRANSLATIONS['common.of'] }} {{ pagination.total_pages }}</a></li>
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link" href="?page={{ pagination.next_page }}&per_page={{ pagination.per_page }}&user_q={{ user_q or '' }}">{{ TRANSLATIONS['index.next'] }}</a>
    </li>
  </ul>
</nav>
{% endblock %}
